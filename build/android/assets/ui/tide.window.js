var CANVASHEIGHT=240,LDF=Ti.Platform.displayCaps.logicalDensityFactor,Moment=require("vendor/moment");Moment.locale("de");var Tide=new(require("controls/bsh.proxy")),Moment=require("vendor/moment"),swipeRefreshModule=require("com.rkam.swiperefreshlayout");module.exports=function(){function e(){console.log("Info: getPrediction is started"),Tide.getPrediction(t.id,{onOk:function(e){if(console.log("Info: getPrediction got results"),i.swipeRefreshContainer.setRefreshing(!1),null==e)return void alert("Für diesen Messpunkt liegen für das Jahr 2015 leider keine Angaben vor. ");n.addScala({current:Math.ceil(e.current.level)+1}),e.current.level?n.moveTo(e.current.direction,e.current.level):n.hide();null==e&&(i.swipeRefreshContainer.setRefreshing(!1),alert("Keine Tidedaten vorhanden – offline?")),i.scheduler.sections=e.predictions.map(function(e,t){var i=Ti.UI.createTableViewSection({headerView:require("ui/tide.headerview")(t,e.label)});return e.tides.forEach(function(e){e.in_past||i.add(require("ui/tide.row")(e))}),i}),console.log("Info: will start renderCanvas"),i.renderCanvas()},onerror:function(){i.swipeRefreshContainer.setRefreshing(!1)}})}var t={label:"Hamburg, St. Pauli",gps:"53.545555,9.97",id:"DE__508P",skn:1.9},i=Ti.UI.createWindow();i.tideCanvas=require("com.wwl.canvas").createCanvasView({backgroundColor:"transparent",bottom:0,width:Ti.UI.FILL,height:Ti.UI.FILL,opacity:0,touchEnabled:!1,height:CANVASHEIGHT,zIndex:9}),i.add(Ti.UI.createImageView({image:"/assets/pano.png",top:0,width:1840,height:700})),i.children[0].animate({left:-320,duration:1500});var n=require("ui/wasserstand").createView();return i.scheduler=Ti.UI.createTableView({top:0,bottom:0,height:Ti.UI.FILL}),i.swipeRefreshContainer=swipeRefreshModule.createSwipeRefresh({view:i.scheduler,top:0,bottom:0,height:Ti.UI.FILL,width:Ti.UI.FILL}),i.swipeRefreshContainer.addEventListener("refreshing",e),i.scheduler.addEventListener("scroll",function(){}),i.renderCanvas=function(){console.log("Info: start rerendering of canvas"),i.tideCanvas.setOpacity(0),i.tideCanvas.clear(),i.tideCanvas.animate({opacity:.4,duration:1e3});var e=Ti.Platform.displayCaps.platformWidth/LDF;i.tideCanvas.lineWidth=1,i.tideCanvas.strokeStyle="#092B55",i.tideCanvas.antiAliasing=!0,i.tideCanvas.beginPath(),i.tideCanvas.moveTo(0,CANVASHEIGHT),i.tidedata=Tide.getChartData(t.id);for(var n=((new Date).getTime(),0);n<i.tidedata.length-1&&e*LDF>n;n+=1)if("object"==typeof i.tidedata[n]&&"number"==typeof i.tidedata[n].level){{i.tidedata[n].level/5*CANVASHEIGHT*LDF}i.tideCanvas.moveTo(n,CANVASHEIGHT*LDF),i.tideCanvas.lineTo(n,(1-i.tidedata[n].level/5)*CANVASHEIGHT*LDF)}i.tideCanvas.closePath(),i.tideCanvas.stroke()},i.tideCanvas.addEventListener("load",function(){i.renderCanvas()}),i.add(i.swipeRefreshContainer),i.add(i.tideCanvas),i.handlerOverlay=Ti.UI.createView({bottom:0,bubbleParent:!1,height:CANVASHEIGHT/2}),i.redline=Ti.UI.createView({bottom:0,touchEnabled:!1,height:CANVASHEIGHT/2,width:2/LDF,opacity:0,backgroundColor:"#8a00"}),i.bubble=Ti.UI.createLabel({backgroundColor:"red",color:"white",width:Ti.UI.SIZE,zIndex:999,font:{fontSize:9},borderRadius:3,height:Ti.UI.SIZE}),i.add(i.bubble),i.add(i.handlerOverlay),i.add(i.redline),i.handlerOverlay.addEventListener("touchmove",function(e){if(i.tidedata){var t=Math.floor(e.x/LDF),n=i.tidedata[t*LDF].level/5*CANVASHEIGHT+10;i.redline.setOpacity(1),i.redline.setHeight(n),i.redline.setLeft(t),i.bubble.setText(" Pegel: "+i.tidedata[t*LDF].level.toFixed(2)+" m \n "+Moment(1e3*i.tidedata[t*LDF].time).format("dd, HH:mm")+" Uhr "),i.bubble.setLeft(t),i.bubble.setBottom(n)}}),Ti.Android&&i.addEventListener("focus",function(){console.log("Info: tide window got focus"),e()}),Ti.Android&&i.addEventListener("open",function(){console.log("Info: tide window is opened"),Ti.UI.createNotification({message:"Gezeitendaten für St. Pauli vom Bundesamt für Seeschiffahrt und Hydrographie"}).show()}),i.add(n),i};