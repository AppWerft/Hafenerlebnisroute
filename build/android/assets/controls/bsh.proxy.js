var Moment=require("vendor/moment"),getDistance=function(e,t,i,a){var n=6371e3,r=(i-e)*Math.PI/180,o=(a-t)*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2),l=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),d=n*l;return Math.round(d)},splitIntoDays=function(e){for(var t=[],i=Moment().startOf("day"),a=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"],n=0;n<e.length;n++){var r,o,s=e[n];r=Moment.unix(s.timestamp).diff(i,"days"),o=3>r?["Heute","Morgen","Übermorgen"][r]:"nächster "+a[Moment.unix(s.timestamp).format("e")],t[r]||(t[r]={}),t[r].label=o,t[r].tides||(t[r].tides=[]),t[r].tides.push({i18n:Moment.unix(s.timestamp).format("HH:mm"),direction:s.direction,level:s.level,in_past:Moment().diff(Moment.unix(s.timestamp))>0?!0:!1})}return t},getCurrent=function(e){for(var t={prev:{},next:{},diff:{level:0,time:0},current:{level:null,timeratio:null}},i=0;i<e.length-1;i++){var a=Moment.unix(e[i].timestamp);if(a.diff(Moment())<=0&&(t.prev=e[i]),a.diff(Moment())>=0){t.next=e[i];break}}t.diff.time=t.next.timestamp-t.prev.timestamp,t.current.timeratio=(Moment().unix()-t.prev.timestamp)/t.diff.time;try{t.diff.level=parseFloat(t.next.level,10)-parseFloat(t.prev.level,10)}catch(n){console.log(n)}if(0==t.diff.level||isNaN(t.diff.level))t.current.level=null;else{var r=Math.abs(parseFloat(t.prev.level,10)-parseFloat(t.next.level,10)),o=Math.cos(t.current.timeratio*Math.PI);if(t.diff.level<0){var s=parseFloat(t.next.level,10);s=r/2+o*r/2+s}else{var s=parseFloat(t.prev.level,10);s=r/2-o*r/2+s}t.current.level=s.toFixed(1)}return t.current.direction="HW"==t.prev.type?"-":"+",t.current.text=t.diff.level<0?"⬇ ablaufend":"⬆ auflaufend",t.next.zeit=Moment.unix(t.next.timestamp).format("D. MMM  HH:mm"),t},TideAdapter=function(){this.locations=require("model/locations").locations;var e=Ti.Database.open(Ti.App.Properties.getString("dbname"));return e.execute("CREATE TABLE IF NOT EXISTS tides (id TEXT, ts TEXT,ty TEXT,level TEXT)"),e.close(),this.getModus(),this};TideAdapter.prototype={loadStations:function(e,t){if(e&&this.getStationsStatus().days==Ti.App.Properties.getString("DAYS"))return void t.onload({ok:!0});var i=((new Date).getTime(),Ti.Network.createHTTPClient({ondatastream:function(e){t.onprogress(e.progress<0?-e.progress/61e4:e.progress)},onload:function(){{var e=null;(new Date).getTime()}try{e=JSON.parse(this.responseText);{(new Date).getTime()}}catch(i){t.onload({ok:!1})}if(null!=e){var a=0,n=Ti.Database.open(Ti.App.Properties.getString("dbname"));n.execute("DROP TABlE IF EXISTS tides"),n.execute("CREATE TABLE IF NOT EXISTS tides (id TEXT, ts TEXT,ty TEXT,level TEXT)"),n.execute("BEGIN IMMEDIATE TRANSACTION");for(var r=0,o=e.length;o>r;r++)for(var s=e[r].id,l=e[r].val,d=0;d<l.length;d++)l&&(a++,n.execute("INSERT INTO tides VALUES (?,?,?,?)",s,l[d].ts,l[d].ty,l[d].m));n.execute("COMMIT TRANSACTION");var p="SELECT ts FROM `tides` ORDER BY ts DESC",m=n.execute(p);if(m.isValidRow())var u=m.fieldByName("ts");m.close(),n.close();{(new Date).getTime()}t.onload({ok:!0,total:a,latest:Moment.unix(u).format("LLL")})}},onerror:function(){Ti.Android&&Ti.UI.createNotification({message:"Nicht im Netz: benutzte alte Daten"}).show(),t.onload({ok:!1})}}));i.open("GET",Ti.App.Properties.getString("ENDPOINT")+"tides.json"),i.setRequestHeader("Accept","application/json"),i.send()},getStationsStatus:function(){var e=Ti.Database.open(Ti.App.Properties.getString("dbname")),t=e.execute("SELECT COUNT(*) AS total,MAX(ts) AS max, MIN(ts) AS min  FROM `tides` WHERE ts>?",Moment().unix());return t.isValidRow()?(min=t.fieldByName("min"),max=t.fieldByName("max"),total=t.fieldByName("total"),t.close(),e.close(),{total:total,days:Math.floor((max-min)/3600/24)}):{total:0,days:0}},getPrediction:function(e,t){this.modus=this.getModus();for(var i=0,a=0;a<this.locations.length;a++)if(this.locations[a].id==e){i=this.locations[a].skn;break}for(var n=Ti.Database.open(Ti.App.Properties.getString("dbname")),r=n.execute("SELECT * FROM tides WHERE id=? ORDER by ts LIMIT 20",e),o=[];r.isValidRow();){var s=parseFloat(r.fieldByName("level")-i),l=parseFloat(r.fieldByName("level")),d="nn"==this.modus?s:l;o.push({timestamp:parseInt(r.fieldByName("ts"),10),level:isNaN(d)?null:d,direction:r.fieldByName("ty")}),r.next()}if(r.close(),n.close(),o.length>0){var p=getCurrent(o),m={current:p.current,next:p.next,prev:p.prev,predictions:splitIntoDays(o)};if(!t||!t.onOk)return m;t.onOk(m)}return null},setModus:function(e){Ti.App.Properties.setString("MODUS",e),Ti.App.fireEvent("app:modus_changed",{modus:e})},getModus:function(){return this.modus=Ti.App.Properties.hasProperty("MODUS")?Ti.App.Properties.getString("MODUS"):"skn",this.modus},getChartData:function(e){for(var t=((new Date).getTime(),[]),i=(Moment(),Ti.Database.open(Ti.App.Properties.getString("dbname"))),a=i.execute("SELECT * FROM tides WHERE id=? ORDER by ts",e),t=[];a.isValidRow();){var n=parseFloat(a.fieldByName("level"));t.push({timestamp:parseInt(a.fieldByName("ts")),level:isNaN(n)?0:n.toFixed(2)}),a.next()}a.close(),i.close();for(var r,o=[],s=0;s<t.length-1;s++){r=t[s+1].timestamp;for(var l=getInterpolatedTideValues({y1:t[s].level,y2:t[s+1].level,t1:t[s].timestamp,t2:t[s+1].timestamp,steps:200}),d=0;d<l.length;d++)o.push(l[d])}return o}};var getInterpolatedTideValues=function(e){for(var t=parseFloat(e.y1),i=parseFloat(e.y2),a=parseFloat(e.t1),n=parseFloat(e.t2),r=Math.abs(i-t)/2,o=n-a,s=Moment().unix(),l=[],d=0;d<e.steps;d++){var p=a+d/e.steps*o,m=Math.cos(d/e.steps*Math.PI),u=i>t?t+r*(1-m):i+r*(1+m);p>s&&l.push({level:u,time:p})}return l};module.exports=TideAdapter;