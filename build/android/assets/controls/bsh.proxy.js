var Moment=require("vendor/moment"),getDistance=function(e,t,a,i){var n=6371e3,o=(a-e)*Math.PI/180,r=(i-t)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),p=n*l;return Math.round(p)},splitIntoDays=function(e){for(var t=[],a=Moment().startOf("day"),i=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"],n=0;n<e.length;n++){var o,r,s=e[n];o=Moment.unix(s.timestamp).diff(a,"days"),r=3>o?["Heute","Morgen","Übermorgen"][o]:"nächster "+i[Moment.unix(s.timestamp).format("e")],t[o]||(t[o]={}),t[o].label=r,t[o].tides||(t[o].tides=[]),t[o].tides.push({i18n:Moment.unix(s.timestamp).format("HH:mm"),direction:s.direction,level:s.level,in_past:Moment().diff(Moment.unix(s.timestamp))>0?!0:!1})}return t},getCurrent=function(e){for(var t={prev:{},next:{},diff:{level:0,time:0},current:{level:null,timeratio:null}},a=0;a<e.length-1;a++){var i=Moment.unix(e[a].timestamp);if(i.diff(Moment())<=0&&(t.prev=e[a]),i.diff(Moment())>=0){t.next=e[a];break}}t.diff.time=t.next.timestamp-t.prev.timestamp,t.current.timeratio=(Moment().unix()-t.prev.timestamp)/t.diff.time,console.log(t);try{t.diff.level=parseFloat(t.next.level,10)-parseFloat(t.prev.level,10)}catch(n){console.log("Error 77: "+n)}if(0==t.diff.level||isNaN(t.diff.level))t.current.level=null;else{var o=Math.abs(parseFloat(t.prev.level,10)-parseFloat(t.next.level,10)),r=Math.cos(t.current.timeratio*Math.PI);if(t.diff.level<0){var s=parseFloat(t.next.level,10);s=o/2+r*o/2+s}else{var s=parseFloat(t.prev.level,10);s=o/2-r*o/2+s}t.current.level=s.toFixed(1)}return t.current.direction="HW"==t.prev.type?"-":"+",t.current.text=t.diff.level<0?"⬇ ablaufend":"⬆ auflaufend",t.next.zeit=Moment.unix(t.next.timestamp).format("D. MMM  HH:mm"),t},TideAdapter=function(){this.locations=require("model/locations").locations,console.log(this.locations);var e=Ti.Database.open(Ti.App.Properties.getString("dbname"));return e.execute("CREATE TABLE IF NOT EXISTS tides (id TEXT, ts TEXT,ty TEXT,level TEXT)"),e.close(),this.getModus(),this};TideAdapter.prototype={loadStations:function(e,t){console.log("Info: START data mirroring ==============================================");if(e&&this.getStationsStatus().days==Ti.App.Properties.getString("DAYS"))return void t.onload({ok:!0});var a=((new Date).getTime(),Ti.Network.createHTTPClient({ondatastream:function(e){t.onprogress(e.progress<0?-e.progress/61e4:e.progress)},onload:function(){{var e=null;(new Date).getTime()}try{e=JSON.parse(this.responseText);{(new Date).getTime()}}catch(a){t.onload({ok:!1})}if(null!=e){var i=0,n=Ti.Database.open(Ti.App.Properties.getString("dbname"));n.execute("DROP TABlE IF EXISTS tides"),n.execute("CREATE TABLE IF NOT EXISTS tides (id TEXT, ts TEXT,ty TEXT,level TEXT)"),n.execute("BEGIN IMMEDIATE TRANSACTION");for(var o=0,r=e.length;r>o;o++)for(var s=e[o].id,l=e[o].val,p=0;p<l.length;p++)l&&(i++,n.execute("INSERT INTO tides VALUES (?,?,?,?)",s,l[p].ts,l[p].ty,l[p].m));n.execute("COMMIT TRANSACTION");var d="SELECT ts FROM `tides` ORDER BY ts DESC",m=n.execute(d);if(m.isValidRow())var u=m.fieldByName("ts");m.close(),n.close();{(new Date).getTime()}t.onload({ok:!0,total:i,latest:Moment.unix(u).format("LLL")})}},onerror:function(){Ti.Android&&Ti.UI.createNotification({message:"Nicht im Netz: benutzte alte Daten"}).show(),t.onload({ok:!1})}}));a.open("GET",Ti.App.Properties.getString("ENDPOINT")+"tides.json"),a.setRequestHeader("Accept","application/json"),a.send()},getStationsStatus:function(){var e=Ti.Database.open(Ti.App.Properties.getString("dbname")),t=e.execute("SELECT COUNT(*) AS total,MAX(ts) AS max, MIN(ts) AS min  FROM `tides` WHERE ts>?",Moment().unix());return t.isValidRow()?(min=t.fieldByName("min"),max=t.fieldByName("max"),total=t.fieldByName("total"),t.close(),e.close(),{total:total,days:Math.floor((max-min)/3600/24)}):{total:0,days:0}},getPrediction:function(e,t){this.modus=this.getModus();for(var a=0,i=0;i<this.locations.length;i++)if(this.locations[i].id==e){a=this.locations[i].skn;break}for(var n=Ti.Database.open(Ti.App.Properties.getString("dbname")),o=n.execute("SELECT * FROM tides WHERE id=? ORDER by ts LIMIT 20",e),r=[];o.isValidRow();){var s=parseFloat(o.fieldByName("level")-a),l=parseFloat(o.fieldByName("level")),p="nn"==this.modus?s:l;r.push({timestamp:parseInt(o.fieldByName("ts"),10),level:isNaN(p)?null:p,direction:o.fieldByName("ty")}),o.next()}if(o.close(),n.close(),r.length>0){var d=getCurrent(r),m={current:d.current,next:d.next,prev:d.prev,predictions:splitIntoDays(r)};if(!t||!t.onOk)return m;t.onOk(m)}return null},setModus:function(e){Ti.App.Properties.setString("MODUS",e),Ti.App.fireEvent("app:modus_changed",{modus:e})},getModus:function(){return this.modus=Ti.App.Properties.hasProperty("MODUS")?Ti.App.Properties.getString("MODUS"):"skn",this.modus},getChartData:function(e){for(var t=(new Date).getTime(),a=[],i=(Moment(),Ti.Database.open(Ti.App.Properties.getString("dbname"))),n=i.execute("SELECT * FROM tides WHERE id=? ORDER by ts",e),a=[];n.isValidRow();){var o=parseFloat(n.fieldByName("level"));a.push({timestamp:parseInt(n.fieldByName("ts")),level:isNaN(o)?0:o.toFixed(2)}),n.next()}n.close(),i.close();for(var r,s=[],l=0;l<a.length-1;l++){r=a[l+1].timestamp;for(var p=getInterpolatedTideValues({y1:a[l].level,y2:a[l+1].level,t1:a[l].timestamp,t2:a[l+1].timestamp,steps:200}),d=0;d<p.length;d++)s.push(p[d])}return console.log("Info: calculating of chart: "+((new Date).getTime()-t)),s}};var getInterpolatedTideValues=function(e){for(var t=parseFloat(e.y1),a=parseFloat(e.y2),i=parseFloat(e.t1),n=parseFloat(e.t2),o=Math.abs(a-t)/2,r=n-i,s=Moment().unix(),l=[],p=0;p<e.steps;p++){var d=i+p/e.steps*r,m=Math.cos(p/e.steps*Math.PI),u=a>t?t+o*(1-m):a+o*(1+m);d>s&&l.push(u)}return l};module.exports=TideAdapter;